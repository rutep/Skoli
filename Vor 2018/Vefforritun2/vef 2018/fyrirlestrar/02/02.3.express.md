
# Fyrirlestur 2.3 ‚Äî Express
### Vefforritun 2 ‚Äî HBV403G
#### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## St√¶rri bakendar

* G√¶tum vel skrifa√∞ okkar eigin bakenda fr√° grunni
  - A√∞eins nota√∞ einingar √≠ node
  - Engin. Dependency. üò§
* V√¶rum a√∞ finna upp hj√≥li√∞ og ey√∞a t√≠ma

***

## Express

* [Web app framework](http://expressjs.com/) fyrir node
* Sm√°tt √≠ sni√∞um en gefur mikla m√∂guleika √° a√∞ b√¶ta vi√∞ virkni til a√∞ gera h√©rumbil hva√∞ sem er
* `npm install express --save`

***

## Hello world

```javascript
const express = require('express');
const app = express();

const hostname = '127.0.0.1';
const port = 3000;

app.get('/', (req, res) => {
  res.send('Hello World!');
});

app.listen(port, hostname, () => {
  console.log(`Server running at http://${hostname}:${port}/`);
});
```

***

## [Application](http://expressjs.com/en/4x/api.html#app)

* B√∫um til Express forrit me√∞ √æv√≠ a√∞ kalla √≠ `express()`
* S√©r m.a. um:
  - _routing_ fyrir HTTP bei√∞nir
  - Middleware uppsetningar
  - Stillingar √° birtingu (me√∞ HTML)

***

## app.locals

* `app.locals` er hlutur sem geymir g√∂gn fyrir app
  - A√∞gengileg √° me√∞an app keyrir
  - A√∞gengilegt fr√° `request` me√∞ `req.app.locals`

***

## Settings

* Getum stillt `app` me√∞ `get()` og `set()`, t.d.
  - `env`, segir til um hvort app keyri √≠ `production` e√∞a `development`
  - `view engine`, hva√∞a _template_ v√©l vi√∞ notum
  - `views`, √≠ hva√∞a m√∂ppu eru template
  - [o.fl.](http://expressjs.com/en/4x/api.html#app.settings.table)

***

## HTTP a√∞ger√∞ir og express

* `app` hefur f√∂ll sem passa vi√∞ HTTP a√∞ger√∞ir
  - `get()`, `post()`, `put()`, `delete()` og [fleiri](http://expressjs.com/en/4x/api.html#app.METHOD)
  - `all()` √° vi√∞ allar a√∞ger√∞ir

***

## Subapps

* Getum unni√∞ me√∞ m√∂rg app √≠ einu me√∞ `use`
* H√≥pa√∞ saman virkni
* `use` er l√≠ka nota√∞ til a√∞ skilgreina _middleware_

***

```
const express = require('express');
const app = express();
const subapp = express();

app.get('/', (req, res) => {
  res.send('hello world');
});

subapp.get('/', (req, res) => {
  res.send('hello from subapp');
});

app.use('/sub', subapp);
```

---

## [Request hluturinn](http://expressjs.com/en/4x/api.html#req)

* `req` stendur fyrir HTTP request sem kemur fr√° client
  - Getum sk√Ωrt anna√∞ (t.d. `request` e√∞a `foo`) me√∞ √æv√≠ a√∞ sk√Ωra argument anna√∞
* Hefur b√¶√∞i eigindi og f√∂ll

***

## Request eigindi

* `req.url`, erft fr√° `http` og g√¶ti hafa veri√∞ √°tt vi√∞
* `req.originalUrl`, `url` √°n allra afskipta
* `req.ip`, IP tala √æess sem ger√∞i bei√∞ni
* `req.query`, hlutur me√∞ √∂llum querystring breytum
* [o.fl.](http://expressjs.com/en/4x/api.html#req.properties)

***

## Request f√∂ll

* `req.accepts(types)`, athugar hvort client tekur vi√∞ √°kve√∞nu MIME type
  - MIME type segir til um √° hva√∞a formi g√∂gn eru, t.d. `application/json`
* `req.get(header)`, skilar request header, ekki h√°stafan√¶mt

***

## [Response hluturinn](http://expressjs.com/en/4x/api.html#res)

* `res` stendur fyrir HTTP response sem vi√∞ erum a√∞ skila til client
* Hefur b√¶√∞i eigindi og f√∂ll

***

## Response eigindi

* `res.headersSent`, bool sem segir okkur hvort headers hafi veri√∞ sendir client e√∞a ekki
* `res.locals`, hlutur sem inniheldur g√∂gn sem ver√∞a a√∞gengileg fyrir view/template, getum b√¶tt vi√∞ uppl√Ωsingum fr√° request

***

## Response f√∂ll

* `res.write(content)`, erft fr√° `http`, skrifar √≠ response straum
* `res.end()`, erft fr√° `http`, endar response straum og sendir √° client
* `res.send(content)`, skrifar √≠ response straum, t.d. setur `Content-Length` header og endar hann
* `res.status(statusCode)`, setur HTTP status √° response

***

## Response f√∂ll

* `res.set(field, value)`, setur response headers
* `res.json(data)`, einsog `send()` nema sendir JSON g√∂gn
* `res.redirect(location)`, framkv√¶mir redirect √° `location`
* [o.fl.](http://expressjs.com/en/4x/api.html#res.methods)

---

## Routing

* H√∂fum s√©√∞ lei√∞ir til √æess a√∞ √∫tb√∫a sl√≥√∞ir sem keyra √°kve√∞in k√≥√∞a
* Ekki s√©rstaklega handh√¶gt a√∞ gera √≠ h√∂ndunum
* Framework geta hj√°lpa√∞ okkur vi√∞ a√∞ √∫tb√∫a g√≥√∞ar og sk√Ωrar sl√≥√∞ir

***

## Routing

* ‚ÄûFriendly URL‚Äú eru sl√≥√∞ir sem au√∞velt er a√∞ lesa √∫r og nota, b√¶√∞i af f√≥lki og v√©lum
  - `/programming/web` ekki `/?cat=programming&sub=web`
* Einnig stu√∞ningur vi√∞ gagnaflutning, t.d. senda streng gegnum URL
  `/article/foo-bar` skilar okkur f√¶rslu me√∞ eigindi `foo-bar`

***

## Route

* Express hefur [stu√∞ning vi√∞ routing](http://expressjs.com/guide/routing.html)
* _Route_ eru sl√≥√∞ (URI) sem forriti√∞ okkar svarar bei√∞num fr√° client √°
* Samanstendur af URI, HTTP a√∞fer√∞ og einum e√∞a fleirum f√∂llum
  - `app.METHOD(URI, callback)`
  - Margar HTTP a√∞fer√∞ir til, en vi√∞ notum a√∞ mestu `get` og `post`
  - `all` er h√¶gt a√∞ nota til a√∞ svara fyrir _allar a√∞fer√∞ir_

***

## Route

* URI getur nota√∞ regular expressions en √¶ttum a√∞ for√∞ast nema √æurfum virkilega
  - `app.get(/foo.*$/, callback)` svarar fyrir allt sem byrjar √° `/foo`
* Query string er ekki partur af route path, n√°lgumst me√∞ `req.query`

***

## Route callback

* Callback sem skilgreint er fyrir route v√≠sar √≠ _middleware_
* Geta veri√∞ m√∂rg √≠ r√∂√∞
  `app.get('/', cb1, cb2)`
* √ç fylki
  `app.get('/', [cb1, cb2])`
* E√∞a blanda

***

## Route parameters

* Ef vi√∞ skilgreinum route me√∞ _parameter_ getum vi√∞ n√°lgast √æau g√∂gn √≠ `req`
  - `app.get('/users/:userId', cb)`
  - `req.params.userId`

***

## Express Router

* Getum b√∫i√∞ til route √°n √æess a√∞ hafa `app` me√∞ √æv√≠ a√∞ nota `const router = express.Router()`
  - Exportum s√≠√∞an `router`
* Skiptum forriti upp √≠ einingar √æar sem hver s√©r um √°kve√∞in hluta af routes

---

## Middleware √≠ Express

* Hefur a√∞gang a√∞ request og response hlutum og _n√¶sta_ middleware
  - `function middleware(req, res, next)`
* Getur
  - Keyrt k√≥√∞a
  - Breytt `req` e√∞a `res`
  - Enda√∞ request-response keyrslu
  - Kalla√∞ √≠ n√¶sta middleware

***

## Middleware √≠ Express

* Middleware eru keyr√∞ √≠ FIFO r√∂√∞
* **Ver√∞um** a√∞ keyra `next()` √° einhverjum t√≠mapunkti til √æess a√∞ n√¶sta middleware geti teki√∞ vi√∞
  - Fyrir route sem skilar uppl√Ωsingum viljum vi√∞ samt oftast ekki kalla √≠ `next()` heldur `req.send()` til a√∞ enda reponse

***

## Middleware √≠ Express

* Getum skilgreint fyrir
  - Allt forrit
  - Per route
  - Villume√∞h√∂ndlun

***

## Middleware fyrir app

```
function helloWorld(req, res, next) {
  console.log('Hello world!');
  next();
}

app.use(helloWorld);
```

***

## Middleware √° route

```
function userHandler (req, res, next) {
  // ...
  next();
}

router.get('/user/:id', helloWorld, userHandler);
```

***

## Villume√∞h√∂ndlun

* Vi√∞ skilgreinum villume√∞h√∂ndlunar middleware me√∞ auka argument
  - `function (err, req, res, next)`
* Skilgreind seinast √≠ app, √° eftir √∂llum √∂√∞rum middleware
* S√©r um a√∞ taka til, logga villu, senda notanda villuskilabo√∞ o.sfr.

***

## 404 villur

* Getum n√Ωtt okkur middleware til √æess a√∞ gr√≠pa 404 villur
  - Veri√∞ a√∞ reyna a√∞ opna route sem vi√∞ h√∂fum ekki skilgreint
* Setjum middleware √° _eftir_ √∂llum routes sem vi√∞ vitum a√∞ muni a√∞eins keyra ef ekkert hefur sent reponse
  - En samt √° undan villume√∞h√∂ndlun

***

```
app.use(function notfound(req, res, next) {
  res.status(404).send('404 Not Found');
});

app.use(function error(err, req, res, next) {
  console.error(err);
  res.status(500).send('Error occured');
});
```

***

## Innbygg√∞ middleware

* Express hefur innbyggt middleware til a√∞ birta stat√≠skar skr√°r
  - t.d. CSS, myndir
  - `app.use(express.static(path.join(__dirname, 'public')))`
* [Serving static files in Express](http://expressjs.com/en/starter/static-files.html)

---

## Templating

* Til a√∞ birta s√≠√∞u √æurfum vi√∞ a√∞ hafa √∫tlit fyrir hana ‚Äì eitthva√∞ √°kve√∞i√∞ HTML
* Ekki skilvirkt a√∞ √∫tb√∫a sj√°lf HTML me√∞ √æv√≠ a√∞ setja saman strengi
* Template leyfa okkur a√∞ √∫tb√∫a √∫tlit √≥h√°√∞ virkni, vi√∞ f√°um g√∂gn og vi√∞ birtum √æau √° √°kve√∞inn h√°tt
* M√∂rg template m√°l til, t.d.
  - Pug, EJS, Handlebars, Mustache

***

## Template √≠ Express

* S√¶kjum √∫tf√¶rslu √° template m√°li fyrir Express
* Skilgreinum √° `app` hva√∞a template m√°l vi√∞ notum og hvar template eru geymd
  - `app.set('view engine', 'ejs');`
  - `app.set('views', path.join(__dirname, 'views'));`
* `res.render(template, data)` notar skilgreindar template v√©l til a√∞ birta `template` me√∞ `data`


***

## [EJS ‚Äì Embedded JavaScript templates](https://github.com/mde/ejs)

Skrifum HTML en me√∞ EJS syntax til a√∞ n√°lgast g√∂gn og setja saman s√≠√∞ur

* `<% %>` fyrir fl√¶√∞ist√Ωringar
* `<%= %>` til a√∞ birta g√∂gn
* `<%- %>` til a√∞ birta g√∂gn _unescaped_
  - Birtir hr√°tt HTML √≠ g√∂gnum, h√¶ttulegt!

***

## EJS

* `<% include header %>` b√¶tir template √∫r `header.ejs` inn √° vi√∞eigandi sta√∞
* √ñll g√∂gn skilgreind me√∞ `app.locals` eru a√∞gengileg √≠ template
* [N√°nari skj√∂lun √° EJS](https://github.com/mde/ejs/blob/master/docs/syntax.md)

***

## Express generator

* T√≥l sem b√Ωr til grunn fyrir okkur til a√∞ vinna √∫tfr√°
* `npm install -g express-generator`
* `express <heiti-√°-verkefni>`
* Er h√°lfpartinn √∫relt, m√¶li ekki me√∞ notkun
