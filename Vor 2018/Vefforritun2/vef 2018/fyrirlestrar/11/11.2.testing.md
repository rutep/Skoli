# Fyrirlestur 11.2

## Testing

### Vefforritun 2 ‚Äî HBV403G

#### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## Sj√°lfvirkar pr√≥fanir

* √ûegar vi√∞ skrifum k√≥√∞a erum vi√∞ alltaf a√∞ athuga hvernig hann virkar
* Gerum √æa√∞ yfirleitt handvirkt
* Getum eytt t√≠ma og skrifa√∞ pr√≥f fyrir √æessa handvirku athugun

***

## Kostir pr√≥fa

* Getum keyrt m√∂rg pr√≥f hratt, aftur og aftur
* ‚ÄûNotum‚Äú k√≥√∞ann okkar √° me√∞an vi√∞ skrifum hann, getum enda√∞ me√∞ betra API
* Gefur okkur √°kve√∞i√∞ traust √° virkni og a√∞ vi√∞ munum ekki brj√≥ta hana seinna meir

***

## √ìkostir pr√≥fa

* √ûa√∞ tekur t√∂luvert lengri t√≠ma a√∞ skrifa pr√≥f en a√∞ athuga eitthva√∞ handvirkt
* Geta gefi√∞ okkur _falskt_ √∂ryggi um a√∞ √æa√∞ s√©u ekki villur √≠ k√≥√∞anum okkar √æv√≠ vi√∞ skrifu√∞um pr√≥f
* Vi√∞ breytingar √° k√≥√∞a √æarf a√∞ uppf√¶ra pr√≥f og ef √æa√∞ er erfitt er mun au√∞veldara a√∞ sl√∂kkva bara √° √æeim

***

## Unit test

* Ekki vel skilgreint hugtak en..
* Pr√≥f √° einni einingu √≠ einu √°n √æess a√∞ horfa √° alla heildina
  - Eining g√¶ti veri√∞ fall, klasi, m√≥dull
* Sumir segja a√∞ unit test eigi _ekki_ a√∞ snerta √° I/O e√∞a einhverju fyrir utan einingu

***

* Hj√°lpa okkur vi√∞ a√∞ komast a√∞ √æv√≠ hvernig vi√∞ viljum sm√≠√∞a forriti√∞ okkar
* F√°um endurgj√∂f hratt og √∂rugglega me√∞an vi√∞ erum a√∞ skrifa
* Leyfa okkur a√∞ breyta k√≥√∞a me√∞ vissu √∂ryggi ‚Äî erum me√∞ pr√≥f til sta√∞ar sem gr√≠pa villur

***

* Pr√≥fin geta komi√∞ √≠ sta√∞ e√∞a auki√∞ vi√∞ skj√∂lun, s√Ωna b√≥kstaflega hvernig kerfi√∞ virkar
* Fyrir villur sem finnast getum vi√∞ skrifa√∞ pr√≥f √°√∞ur en vi√∞ l√∂gum
  - Minnkum l√≠kur √° a√∞ villa komi upp aftur

***

## Skilvirk test

* Einf√∂ld & DRY (Don't Repeat Yourself)
  - Einn hlutur √≠ einu
* √ìha√∞ r√∂√∞ sem √æau eru keyr√∞ √≠
* Endurtakanleg (repeatable) me√∞ s√∂mu ni√∞urst√∂√∞um
* _Hr√∂√∞_
  - G√¶ti fali√∞ √≠ s√©r a√∞ _mocka_ √∫t allar √æj√≥nustur og st√∂√∞ur

***

## Mocks og stubs

* Mocks herma eftir hlutum √æ.a. vi√∞ vitum n√°kv√¶mlega hvernig heg√∞un ver√∞ur
* Notum ef hlutur er h√¶gur, fl√≥kinn, _brig√∞gengur_ (non-deterministic) o.fl.
* Stubs (stundum kalla√∞ _fake_) eru _stubbar_ sem vi√∞ skrifum √≠ sta√∞inn fyrir virkni, t.d. a√∞ l√°ta fall alltaf skila s√∂mu ni√∞urst√∂√∞u

***

* √ûegar vi√∞ pr√≥fum og notum mocks √æurfum vi√∞ a√∞ passa a√∞ pr√≥fa ekki bara √æau sj√°lf, heldur einbl√≠na √° a√∞ pr√≥fa raunverulega virkni
* Mocks, stubs og fakes eru ekki vel skilgreind hugt√∂k og notu√∞ √° mismunandi h√°tt af mismunandi a√∞ilum

***

## Test harness, test frameworks

* Forrit og stillingar sem sj√° um a√∞ keyra pr√≥fin okkar
* Taka saman ni√∞urst√∂√∞ur og l√°ta vita st√∂√∞una
* Get keyrt virkni _fyrir_ og _eftir_ hvert pr√≥f e√∞a fyrir og eftir √∂ll pr√≥f

***

## Assertions ‚Äî sta√∞h√¶fingar

* Vi√∞ skrifum pr√≥fin okkar √æ.a. √æau sta√∞h√¶fi eitthva√∞ √≠ lokin
  - Vi√∞ gefum r√©tt gildi og athugum hvort √æa√∞ s√© eins
  - `assert(result === 'foo');`
* √Üttum a√∞ hafa f√¶rri en fleiri sta√∞h√¶fingar √≠ hverju pr√≥fi
  - ekki gera of miki√∞
* Ein lei√∞ til a√∞ skipuleggja pr√≥f er a√∞ fylgja _arrange, act, assert_

***

## Arrange, Act, Assert

```javascript
const input = 'bar';        // Arrange

const res = reverse(input); // Act

assert(res === 'rab');      // Assert
```

***

## Test-driven development (TDD)

Endurt√∂kum:

1. Byrjum √° a√∞ skrifa pr√≥f sem bregst
2. Skrifum k√≥√∞a til a√∞ l√°ta pr√≥fi√∞ (og √∂ll √∂nnur pr√≥f) heppnast
3. Hreinsum k√≥√∞a og keyrum pr√≥f

***

![TDD fl√¶√∞i](img/tdd.png "Mynd: https://en.wikipedia.org/wiki/File:Test-driven_development.PNG")

***

## Behavior-driven development (BDD)

* Svipar til TDD en einbl√≠nir √° virkni en ekki pr√≥fin sj√°lf
* Breytum √æv√≠ hvernig vi√∞ skrifum sta√∞h√¶fingar og notum
  - x _√¶tti a√∞ vera jafnt_ y
  - `foo.should.equal('bar')`
  - _b√Ωst vi√∞ a√∞_ x s√© jafnt y
  - `expect(foo).to.equal('bar');`
* Mikil einf√∂ldun √° fl√≥knara hugtaki

***

## Code coverage

* Hversu st√≥rt hlutfall af k√≥√∞anum okkar er pr√≥fa√∞ur?
* Nokkrar skilgreiningar
  - _function_ - hlutfall falla sem kalla√∞ er √≠
  - _statement_ - er hver skipun keyr√∞?
  - _branch_ - hefur hver grein veri√∞ pr√≥fu√∞? T.d. b√¶√∞i `if` og `else`
  - _condition_ - hafa allar seg√∞ir veri√∞ pr√≥fa√∞ar? T.d. `foo && bar` fyrir alla fj√≥ra m√∂guleika

***

## Integration tests

* Pr√≥fa fleiri en eina einingu √≠ einu
  - Uppflettingar √≠ gagnagrunn
  - Samskipti yfir net
  - O.fl.
* G√¶tu teki√∞ lengri t√≠ma

---

## Unit test og node.js

* [Mocha](https://mochajs.org/) er test framework sem sty√∞ur m√∂rg assertion library
* [Chai](http://chaijs.com/) er assertion library sem sty√∞ur `assert`, `should` og `expect`
* [Sinon](http://chaijs.com/) s√©r um mocks og stubs
* [istanbul](https://www.npmjs.com/package/istanbul) fyrir code coverage
* [Nock](https://github.com/pgte/nock) pr√≥far HTTP bei√∞nir

***

## Mocha

* Setjum upp test suite me√∞ `describe`
* Hvert test er innan `it(description, test)`
  - _description_ er l√Ωsing √° pr√≥fi sem byrjar √° _should_
  - _test_ er pr√≥fi√∞ sj√°lft sem fall
* Getum pr√≥fa√∞ √≥samfasa k√≥√∞a [me√∞ `async await` √≠ Mocha](https://mochajs.org/#using-async--await)

***

## Mocha keyrsla

* Setjum upp almennt
  - `npm install -g mocha`
* Getum keyrt me√∞ [m√∂rgum fl√∂ggum](https://mochajs.org/#usage), t.d.:
  - `-w` - Fylgjast me√∞ skr√° og keyra ef breytist
  - `-R` - Hvernig ni√∞ursta√∞a l√≠tur √∫t, t.d. `spec`, `dot`

***

## Mocha & Chai d√¶mi

```javascript
const chai = require('chai');
chai.should();

describe('Array', () => {
  describe('#indexOf()', () => {
    it('should return -1 when the value is not present', () => {
      [1,2,3].indexOf(5).should.equal(-1);
    });
  });
});
```

***

## Jest

* [`jest`](https://github.com/facebook/jest) er test framework fr√° Facebook
* Or√∞i√∞ frekar vins√¶lt og s√©rstaklega me√∞ React
* Kemur uppsett me√∞ `create-react-app` og √≠ skj√∂lun eru [√≠tarlegar lei√∞beiningar](https://github.com/facebook/create-react-app/blob/master/packages/react-scripts/template/README.md#running-tests)
* Getum nota√∞ me√∞ [`enzyme`](http://airbnb.io/enzyme/) til a√∞ sta√∞festa √∫tkomu √∫r componentum

***

```javascript
import React from 'react';
import { shallow } from 'enzyme';
import App from './App';

it('renders welcome message', () => {
  const wrapper = shallow(<App />);
  const welcome = <h2>Welcome to React</h2>;
  expect(wrapper.contains(welcome)).toEqual(true);
});
```

---

## Continuous integration

* Continuous integration (CI) er √æegar vi√∞ keyrum √∂ll test vi√∞ hvert commit √≠ source control
* ‚ÄûIntegration‚Äú kemur fr√° √æv√≠ a√∞ vi√∞ erum a√∞ _integratea_ vi√∞ `master` branch
  - Ef √æa√∞ er gert sjaldan getur komi√∞ upp sta√∞a √æar sem gefa √° √∫t og √æa√∞ √æarf a√∞ mergea m√∂rgu √≠ einu
  - _Integration hell_
* H√∂fum √°kve√∞i√∞ traust √° √æv√≠ a√∞ `master` s√© alltaf tilb√∫i√∞ til √∫tg√°fu

***

## Continuous deployment

* Continuous deployment er √æegar vi√∞ gefum `master` √∫t √° raunkerfi fyrir hverja breytingu sem stenst pr√≥f
* H√∂ldum `master` alltaf √≠ _deployable_ √°standi
* H√¶gt a√∞ gefa √∫t oft √° dag

***

## Heroku CI

* Getum sett upp CI √° Heroku ef vi√∞ notum [_pipelines_](https://devcenter.heroku.com/articles/pipelines)
* Skilgreinum nokkur √∂pp saman √≠ pipeline, t.d.
  - `dev`, alltaf n√Ωjasta √∫tg√°fa af `master`, tengist √ær√≥unar√æj√≥nustum
  - `test`, √∫tg√°fa sem veri√∞ er a√∞ fara a√∞ gefa √∫t, tengist raun√æj√≥nustum e√∞a afriti af √æeim
  - `prod`, raunkeyrsla √° kerfi

***

* Ef vi√∞ tengjum pipeline vi√∞ GitHub getum vi√∞ _sj√°lfkrafa_ b√∫i√∞ til n√Ω √∂pp fyrir hvert PR
* create-react-app buildpack [hefur stu√∞ning vi√∞ Heroku CI](https://github.com/mars/create-react-app-buildpack#testing)
* Heroku + Git + test + CI = üòç

***

## A√∞rar CI √æj√≥nustur

* [Travis](https://travis-ci.org/)
* [CircleCI](http://circleci.com/)
